# Module: Kenobi

Author: Jackson Warren  
Date: August 30, 2022  

## Description  
Walkthrough on exploiting a Linux machine. Enumerate Samba for shares, manipulate a vulnerable version of proftpd and escalate your privileges with path variable manipulation.  

This room will cover accessing a Samba share, manipulating a vulnerable version of proftpd to gain initial access and escalate your privileges to root via an SUID binary.  

## Nmap Scan

They give a hint nmap scan and we tack on our usual output log

`$ nmap ip -vvv -oN scans/nmap.out 10.10.40.11`

```
➜  Kenobi git:(main) ✗ nmap ip -vvv -oN scans/nmap.out 10.10.40.11
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-30 23:26 CST
Failed to resolve "ip".
Initiating Ping Scan at 23:27
Scanning 10.10.40.11 [2 ports]
Completed Ping Scan at 23:27, 0.17s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 23:27
Completed Parallel DNS resolution of 1 host. at 23:27, 0.08s elapsed
DNS resolution of 1 IPs took 0.08s. Mode: Async [#: 1, OK: 0, NX: 1, DR: 0, SF: 0, TR: 1, CN: 0]
Initiating Connect Scan at 23:27
Scanning 10.10.40.11 [1000 ports]
Discovered open port 111/tcp on 10.10.40.11
Discovered open port 445/tcp on 10.10.40.11
Discovered open port 21/tcp on 10.10.40.11
Discovered open port 22/tcp on 10.10.40.11
Discovered open port 80/tcp on 10.10.40.11
Discovered open port 139/tcp on 10.10.40.11
Discovered open port 2049/tcp on 10.10.40.11
Increasing send delay for 10.10.40.11 from 0 to 5 due to max_successful_tryno increase to 4
Increasing send delay for 10.10.40.11 from 5 to 10 due to max_successful_tryno increase to 5
Completed Connect Scan at 23:27, 23.76s elapsed (1000 total ports)
Nmap scan report for 10.10.40.11
Host is up, received syn-ack (0.17s latency).
Scanned at 2022-08-30 23:27:09 CST for 24s
Not shown: 993 closed tcp ports (conn-refused)
PORT     STATE SERVICE      REASON
21/tcp   open  ftp          syn-ack
22/tcp   open  ssh          syn-ack
80/tcp   open  http         syn-ack
111/tcp  open  rpcbind      syn-ack
139/tcp  open  netbios-ssn  syn-ack
445/tcp  open  microsoft-ds syn-ack
2049/tcp open  nfs          syn-ack

Read data files from: /usr/bin/../share/nmap
Nmap done: 1 IP address (1 host up) scanned in 39.22 seconds
```

Scan the machine with nmap, how many ports are open?  
Answer: **7**

## Enumerating Shares For Samba



Using nmap we can enumerate a machine for SMB shares.

Nmap has the ability to run to automate a wide variety of networking tasks. There is a script to enumerate shares!

SMB has two ports, 445 and 139.

`$ nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse 10.10.40.11`

```
➜  Kenobi git:(main) ✗ nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse -oN scans/nmap-smb.out 10.10.40.11
Starting Nmap 7.92 ( https://nmap.org ) at 2022-08-30 23:32 CST
Nmap scan report for 10.10.40.11
Host is up (0.17s latency).

PORT    STATE SERVICE
445/tcp open  microsoft-ds

Host script results:
| smb-enum-shares: 
|   account_used: guest
|   \\10.10.40.11\IPC$: 
|     Type: STYPE_IPC_HIDDEN
|     Comment: IPC Service (kenobi server (Samba, Ubuntu))
|     Users: 1
|     Max Users: <unlimited>
|     Path: C:\tmp
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.40.11\anonymous: 
|     Type: STYPE_DISKTREE
|     Comment: 
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\home\kenobi\share
|     Anonymous access: READ/WRITE
|     Current user access: READ/WRITE
|   \\10.10.40.11\print$: 
|     Type: STYPE_DISKTREE
|     Comment: Printer Drivers
|     Users: 0
|     Max Users: <unlimited>
|     Path: C:\var\lib\samba\printers
|     Anonymous access: <none>
|_    Current user access: <none>

Nmap done: 1 IP address (1 host up) scanned in 26.13 seconds
```
Using the nmap command above, how many shares have been found?  
Answer: **3**

On most distributions of Linux smbclient is already installed. Lets inspect one of the shares.

`$ smbclient //<ip>/anonymous`

Using your machine, connect to the machines network share.

Once you're connected, list the files on the share. What is the file can you see?  
Answer: **log.txt**


You can recursively download the SMB share too. Submit the username and password as nothing.

`$ smbget -R smb://<ip>/anonymous`

Open the file on the share. There is a few interesting things found.

    Information generated for Kenobi when generating an SSH key for the user
    Information about the ProFTPD server.

What port is FTP running on?
`$ grep -i "ftp" log.txt`
Answer: **21**



Your earlier nmap port scan will have shown port 111 running the service rpcbind. This is just a server that converts remote procedure call (RPC) program number into universal addresses. When an RPC service is started, it tells rpcbind the address at which it is listening and the RPC program number its prepared to serve. 

In our case, port 111 is access to a network file system. Lets use nmap to enumerate this.

`$ nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount -oN scans/nmap-rpc.out 10.10.40.11`

What mount can we see?  
Answer: **/var**

## Get Initial Access With ProFtpd

ProFtpd is a free and open-source FTP server, compatible with Unix and Windows systems. Its also been vulnerable in the past software versions.

Lets get the version of ProFtpd. Use netcat to connect to the machine on the FTP port.

What is the version?  
`$ nc 10.10.40.11 21`  
Answer: **1.3.5**

---

We can use searchsploit to find exploits for a particular software version.

Searchsploit is basically just a command line search tool for exploit-db.com.

How many exploits are there for the ProFTPd running?  
`$ searchsploit proftp 1.3.5`  
Answer: **4**

---

You should have found an exploit from ProFtpd's mod_copy module. 

The mod_copy module implements SITE CPFR and SITE CPTO commands, which can be used to copy files/directories from one place to another on the server. Any unauthenticated client can leverage these commands to copy files from any part of the filesystem to a chosen destination.

We know that the FTP service is running as the Kenobi user (from the file on the share) and an ssh key is generated for that user. 













